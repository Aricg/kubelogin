<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Introduction - Azure Kubelogin</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="A Kubernetes credential (exec) plugin implementing azure authentication">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html" class="active"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="development.html"><strong aria-hidden="true">2.</strong> Development</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="development/releasing.html"><strong aria-hidden="true">2.1.</strong> Releasing</a></li></ol></li><li class="chapter-item expanded "><a href="contributing.html"><strong aria-hidden="true">3.</strong> Contributing</a></li><li class="chapter-item expanded "><a href="code-of-conduct.html"><strong aria-hidden="true">4.</strong> Code of Conduct</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Azure Kubelogin</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/Azure/kubelogin" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="kubelogin"><a class="header" href="#kubelogin">kubelogin</a></h1>
<p><a href="https://goreportcard.com/report/github.com/Azure/kubelogin"><img src="https://goreportcard.com/badge/github.com/Azure/kubelogin" alt="Go Report Card" /></a>
<a href="https://github.com/Azure/kubelogin/actions/workflows/golangci-lint.yml"><img src="https://github.com/Azure/kubelogin/actions/workflows/golangci-lint.yml/badge.svg" alt="golangci-lint" /></a>
<a href="https://github.com/Azure/kubelogin/actions/workflows/build.yml"><img src="https://github.com/Azure/kubelogin/actions/workflows/build.yml/badge.svg" alt="Build on Push" /></a>
<a href="https://pkg.go.dev/github.com/Azure/kubelogin"><img src="https://pkg.go.dev/badge/github.com/Azure/kubelogin.svg" alt="Go Reference" /></a></p>
<p>This is a <a href="https://kubernetes.io/docs/reference/access-authn-authz/authentication/#client-go-credential-plugins">client-go credential (exec) plugin</a> implementing azure authentication. This plugin provides features that are not available in kubectl. It is supported on kubectl v1.11+</p>
<h2 id="features"><a class="header" href="#features">Features</a></h2>
<ul>
<li><code>convert-kubeconfig</code> command to converts kubeconfig with existing azure auth provider format to exec credential plugin format</li>
<li><a href="#device-code-flow-interactive">interactive device code login</a></li>
<li><a href="#web-browser-flow-interactive">interactive web browser login</a></li>
<li><a href="#service-principal-login-flow-non-interactive">non-interactive service principal login</a></li>
<li><a href="#user-principal-login-flow-non-interactive">non-interactive user principal login</a> using <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth-ropc">Resource owner login flow</a></li>
<li><a href="#managed-service-identity-non-interactive">non-interactive managed service identity login</a></li>
<li><a href="#azure-cli-token-login-non-interactive">non-interactive Azure CLI token login (AKS only)</a></li>
<li><a href="#azure-workload-federated-identity-non-interactive">non-interactive workload identity login</a></li>
<li>AAD token will be cached locally for renewal in device code login and user principal login (ropc) flow. By default, it is saved in <code>~/.kube/cache/kubelogin/</code></li>
<li>addresses <a href="https://github.com/kubernetes/kubernetes/issues/86410">https://github.com/kubernetes/kubernetes/issues/86410</a> to remove <code>spn:</code> prefix in <code>audience</code> claim, if necessary. (based on kubeconfig or commandline argument <code>--legacy</code>)</li>
<li><a href="#setup-for-kubernetes-oidc-provider-using-azure-ad">Setup for Kubernetes OIDC Provider using Azure AD</a></li>
</ul>
<h2 id="getting-started"><a class="header" href="#getting-started">Getting Started</a></h2>
<h3 id="setup"><a class="header" href="#setup">Setup</a></h3>
<p>Copy the latest <a href="https://github.com/Azure/kubelogin/releases">Releases</a> to shell’s search path.</p>
<h3 id="setup-homebrew"><a class="header" href="#setup-homebrew">Setup (homebrew)</a></h3>
<pre><code class="language-sh"># install
brew install Azure/kubelogin/kubelogin

# upgrade
brew update
brew upgrade Azure/kubelogin/kubelogin
</code></pre>
<h3 id="setup-windows"><a class="header" href="#setup-windows">Setup (Windows)</a></h3>
<h4 id="using-winget"><a class="header" href="#using-winget">Using winget</a></h4>
<p>From Powershell:</p>
<pre><code class="language-powershell">winget install --id=Kubernetes.kubectl  -e
winget install --id=Microsoft.Azure.Kubelogin  -e
</code></pre>
<h4 id="using-azure-cli"><a class="header" href="#using-azure-cli">Using azure cli</a></h4>
<p>From Powershell:</p>
<pre><code class="language-powershell">az aks install-cli
$targetDir=&quot;$env:USERPROFILE\.azure-kubelogin&quot;
$oldPath = [System.Environment]::GetEnvironmentVariable(&quot;Path&quot;,&quot;User&quot;)
$oldPathArray=($oldPath) -split &quot;;&quot;
if(-Not($oldPathArray -Contains &quot;$targetDir&quot;)) {
    write-host &quot;Permanently adding $targetDir to User Path&quot;
    $newPath = &quot;$oldPath;$targetDir&quot; -replace &quot;;+&quot;, &quot;;&quot;
    [System.Environment]::SetEnvironmentVariable(&quot;Path&quot;,$newPath,&quot;User&quot;)
    $env:Path = [System.Environment]::GetEnvironmentVariable(&quot;Path&quot;,&quot;User&quot;),[System.Environment]::GetEnvironmentVariable(&quot;Path&quot;,&quot;Machine&quot;) -join &quot;;&quot;
}
</code></pre>
<h3 id="run"><a class="header" href="#run">Run</a></h3>
<h4 id="device-code-flow-interactive"><a class="header" href="#device-code-flow-interactive">Device code flow (interactive)</a></h4>
<pre><code class="language-sh">export KUBECONFIG=/path/to/kubeconfig

kubelogin convert-kubeconfig

kubectl get no
</code></pre>
<blockquote>
<p>Note: although device code flow is the default login mode, it doesn’t work when Conditional Access policy is configured on AAD tenant. Use web browser flow instead.</p>
</blockquote>
<blockquote>
<p>Note: if you are using kubeconfig from AKS AADv1 clusters, <code>convert-kubeconfig</code> command will automatically add <code>--legacy</code> flag so that <code>audience</code> claim will have <code>spn:</code> prefix.</p>
</blockquote>
<h4 id="web-browser-flow-interactive"><a class="header" href="#web-browser-flow-interactive">Web browser flow (interactive)</a></h4>
<pre><code class="language-sh">export KUBECONFIG=/path/to/kubeconfig

kubelogin convert-kubeconfig -l interactive

kubectl get no
</code></pre>
<h4 id="service-principal-login-flow-non-interactive"><a class="header" href="#service-principal-login-flow-non-interactive">Service principal login flow (non interactive)</a></h4>
<blockquote>
<p>On AKS, it will only work with managed AAD. Service principal can be member of maximum 250 AAD groups.</p>
</blockquote>
<p>Create a service principal or use an existing one.</p>
<pre><code class="language-sh">az ad sp create-for-rbac --skip-assignment --name myAKSAutomationServicePrincipal
</code></pre>
<p>The output is similar to the following example.</p>
<pre><code class="language-json">{
  &quot;appId&quot;: &quot;&lt;spn client id&gt;&quot;,
  &quot;displayName&quot;: &quot;myAKSAutomationServicePrincipal&quot;,
  &quot;name&quot;: &quot;http://myAKSAutomationServicePrincipal&quot;,
  &quot;password&quot;: &quot;&lt;spn secret&gt;&quot;,
  &quot;tenant&quot;: &quot;&lt;aad tenant id&gt;&quot;
}
</code></pre>
<p>Query your service principal AAD Object ID by using the command below.</p>
<pre><code class="language-sh">az ad sp show --id &lt;spn client id&gt; --query &quot;id&quot;
</code></pre>
<p>To configure the role binding on Azure Kubernetes Service, the user in rolebinding should be the AAD Object ID.</p>
<p>For example,</p>
<pre><code class="language-yaml">apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: sp-role-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
  - apiGroup: rbac.authorization.k8s.io
    kind: User
    name: &lt;service-principal-object-id&gt;
</code></pre>
<p>Use Kubelogin to convert your kubeconfig</p>
<pre><code class="language-sh">export KUBECONFIG=/path/to/kubeconfig

kubelogin convert-kubeconfig -l spn

export AAD_SERVICE_PRINCIPAL_CLIENT_ID=&lt;spn client id&gt;
export AAD_SERVICE_PRINCIPAL_CLIENT_SECRET=&lt;spn secret&gt;

kubectl get no
</code></pre>
<p>or write your spn secret permanently into the kubeconfig:</p>
<pre><code class="language-sh">export KUBECONFIG=/path/to/kubeconfig

kubelogin convert-kubeconfig -l spn --client-id &lt;spn client id&gt; --client-secret &lt;spn secret&gt;

kubectl get nodes
</code></pre>
<h4 id="user-principal-login-flow-non-interactive"><a class="header" href="#user-principal-login-flow-non-interactive">User Principal login flow (non interactive)</a></h4>
<blockquote>
<p>Note: ROPC is not supported in hybrid identity federation scenarios (for example, Azure AD and ADFS used to authenticate on-premises accounts). If users are full-page redirected to an on-premises identity providers, Azure AD is not able to test the username and password against that identity provider. Pass-through authentication is supported with ROPC, however.
It also does not work when MFA policy is enabled
Personal accounts that are invited to an Azure AD tenant can’t use ROPC</p>
</blockquote>
<pre><code class="language-sh">export KUBECONFIG=/path/to/kubeconfig

kubelogin convert-kubeconfig -l ropc

export AAD_USER_PRINCIPAL_NAME=foo@bar.com
export AAD_USER_PRINCIPAL_PASSWORD=&lt;password&gt;

kubectl get no
</code></pre>
<h4 id="managed-service-identity-non-interactive"><a class="header" href="#managed-service-identity-non-interactive">Managed Service Identity (non interactive)</a></h4>
<pre><code class="language-sh">export KUBECONFIG=/path/to/kubeconfig

kubelogin convert-kubeconfig -l msi

kubectl get no
</code></pre>
<p>To configure the role binding on Azure Kubernetes Service, the user in rolebinding should be the MSI’s AAD Object ID.</p>
<p>For example,</p>
<pre><code class="language-yaml">apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: msi-role-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
  - apiGroup: rbac.authorization.k8s.io
    kind: User
    name: &lt;service-principal-object-id&gt;
</code></pre>
<h4 id="managed-service-identity-with-specific-identity-non-interactive"><a class="header" href="#managed-service-identity-with-specific-identity-non-interactive">Managed Service Identity with specific identity (non interactive)</a></h4>
<pre><code class="language-sh">export KUBECONFIG=/path/to/kubeconfig

kubelogin convert-kubeconfig -l msi --client-id msi-client-id

kubectl get no
</code></pre>
<h4 id="azure-cli-token-login-non-interactive"><a class="header" href="#azure-cli-token-login-non-interactive">Azure CLI token login (non interactive)</a></h4>
<pre><code class="language-sh">export KUBECONFIG=/path/to/kubeconfig

kubelogin convert-kubeconfig -l azurecli

kubectl get no
</code></pre>
<p>Uses an <a href="https://docs.microsoft.com/en-us/cli/azure/account?view=azure-cli-latest#az_account_get_access_token">access token</a> from <a href="https://github.com/Azure/azure-cli">Azure CLI</a> to log in. The token will be issued against whatever tenant was logged in at the time <code>kubelogin convert-kubeconfig -l azurecli</code> was run. This login option only works with managed AAD in AKS.</p>
<h4 id="azure-workload-federated-identity-non-interactive"><a class="header" href="#azure-workload-federated-identity-non-interactive">Azure Workload Federated Identity (non interactive)</a></h4>
<pre><code class="language-sh">export KUBECONFIG=/path/to/kubeconfig

kubelogin convert-kubeconfig -l workloadidentity

kubectl get no
</code></pre>
<p>Workload identity uses <a href="https://docs.microsoft.com/en-us/graph/api/resources/federatedidentitycredentials-overview?view=graph-rest-beta">Azure AD federated identity credentials</a> to authenticate to Kubernetes clusters with AAD integration. This works by setting the environment variables:</p>
<ul>
<li><code>AZURE_CLIENT_ID</code> is Azure Active Directory application ID that is federated with workload identity</li>
<li><code>AZURE_TENANT_ID</code> is Azure Active Directory tenant ID</li>
<li><code>AZURE_FEDERATED_TOKEN_FILE</code> is the file containing signed assertion of workload identity. E.g. Kubernetes projected service account (jwt) token</li>
<li><code>AZURE_AUTHORITY_HOST</code> is the base URL of an Azure Active Directory authority. E.g. <code>https://login.microsoftonline.com/</code></li>
</ul>
<p>With workload identity, it’s possible to access Kubernetes clusters from CI/CD system such as Github, ArgoCD, etc. without storing Service Principal credentials in those external systems. To learn more, <a href="https://github.com/weinong/azure-federated-identity-samples">here</a> is a sample to setup OIDC federation from Github.</p>
<h3 id="clean-up"><a class="header" href="#clean-up">Clean up</a></h3>
<p>Whenever you want to remove cached tokens</p>
<pre><code class="language-sh">kubelogin remove-tokens
</code></pre>
<h2 id="azure-environment"><a class="header" href="#azure-environment">Azure Environment</a></h2>
<p><code>kubelogin</code> supports Azure Environments:</p>
<ul>
<li>AzurePublicCloud (default value)</li>
<li>AzureChinaCloud</li>
<li>AzureUSGovernmentCloud</li>
<li>AzureStackCloud</li>
</ul>
<p>You can specify <code>--environment</code> for <code>kubelogin convert-kubeconfig</code>.</p>
<p>When using <code>AzureStackCloud</code> you will need to specify the actual endpoints in a config file, and set the environment variable <code>AZURE_ENVIRONMENT_FILEPATH</code> to that file.</p>
<p>The configuration parameters of this file:</p>
<pre><code>{
  &quot;name&quot;: &quot;AzureStackCloud&quot;,
  &quot;managementPortalURL&quot;: &quot;...&quot;,
  &quot;publishSettingsURL&quot;: &quot;...&quot;,
  &quot;serviceManagementEndpoint&quot;: &quot;...&quot;,
  &quot;resourceManagerEndpoint&quot;: &quot;...&quot;,
  &quot;activeDirectoryEndpoint&quot;: &quot;...&quot;,
  &quot;galleryEndpoint&quot;: &quot;...&quot;,
  &quot;keyVaultEndpoint&quot;: &quot;...&quot;,
  &quot;graphEndpoint&quot;: &quot;...&quot;,
  &quot;serviceBusEndpoint&quot;: &quot;...&quot;,
  &quot;batchManagementEndpoint&quot;: &quot;...&quot;,
  &quot;storageEndpointSuffix&quot;: &quot;...&quot;,
  &quot;sqlDatabaseDNSSuffix&quot;: &quot;...&quot;,
  &quot;trafficManagerDNSSuffix&quot;: &quot;...&quot;,
  &quot;keyVaultDNSSuffix&quot;: &quot;...&quot;,
  &quot;serviceBusEndpointSuffix&quot;: &quot;...&quot;,
  &quot;serviceManagementVMDNSSuffix&quot;: &quot;...&quot;,
  &quot;resourceManagerVMDNSSuffix&quot;: &quot;...&quot;,
  &quot;containerRegistryDNSSuffix&quot;: &quot;...&quot;,
  &quot;cosmosDBDNSSuffix&quot;: &quot;...&quot;,
  &quot;tokenAudience&quot;: &quot;...&quot;,
  &quot;resourceIdentifiers&quot;: {
    &quot;graph&quot;: &quot;...&quot;,
    &quot;keyVault&quot;: &quot;...&quot;,
    &quot;datalake&quot;: &quot;...&quot;,
    &quot;batch&quot;: &quot;...&quot;,
    &quot;operationalInsights&quot;: &quot;...&quot;
  }
}
</code></pre>
<p>The full configuration is available in the source code at <a href="https://github.com/Azure/go-autorest/blob/master/autorest/azure/environments.go">https://github.com/Azure/go-autorest/blob/master/autorest/azure/environments.go</a>.</p>
<h2 id="exec-plugin-format"><a class="header" href="#exec-plugin-format">Exec Plugin Format</a></h2>
<p>Below is what a kubeconfig with exec plugin would look like. By default, the <code>audience</code> claim will not have <code>spn:</code> prefix. If it’s desired to keep the prefix, add <code>--legacy</code> to the args.</p>
<p>Note: The AAD server app ID of AKS Managed AAD is always <code>6dae42f8-4368-4678-94ff-3960e28e3630</code> in any environments.</p>
<blockquote>
<p>cluster info including cluster CA and FQDN are omitted in below examples</p>
</blockquote>
<h3 id="device-code-flow-default"><a class="header" href="#device-code-flow-default">Device Code Flow (default)</a></h3>
<pre><code class="language-yaml">kind: Config
preferences: {}
users:
  - name: user-name
    user:
      exec:
        apiVersion: client.authentication.k8s.io/v1beta1
        command: kubelogin
        args:
          - get-token
          - --environment
          - AzurePublicCloud
          - --server-id
          - &lt;AAD server app ID&gt;
          - --client-id
          - &lt;AAD client app ID&gt;
          - --tenant-id
          - &lt;AAD tenant ID&gt;
</code></pre>
<h3 id="web-browser-flow-default"><a class="header" href="#web-browser-flow-default">web browser Flow (default)</a></h3>
<pre><code class="language-yaml">kind: Config
preferences: {}
users:
  - name: user-name
    user:
      exec:
        apiVersion: client.authentication.k8s.io/v1beta1
        args:
        - get-token
        - --login
        - interactive
        - --server-id
        - &lt;AAD server app ID&gt;
        - --client-id
        - &lt;AAD client app ID&gt;
        - --tenant-id
        - &lt;AAD tenant ID&gt;
        - --environment
        - AzurePublicCloud
        command: kubelogin
</code></pre>
<h3 id="spn-login-with-secret"><a class="header" href="#spn-login-with-secret">Spn login with secret</a></h3>
<pre><code class="language-yaml">kind: Config
preferences: {}
users:
  - name: demouser
    user:
      exec:
        apiVersion: client.authentication.k8s.io/v1beta1
        args:
          - get-token
          - --environment
          - AzurePublicCloud
          - --server-id
          - &lt;AAD server app ID&gt;
          - --client-id
          - &lt;AAD client app ID&gt;
          - --client-secret
          - &lt;client_secret&gt;
          - --tenant-id
          - &lt;AAD tenant ID&gt;
          - --login
          - spn
        command: kubelogin
        env: null
</code></pre>
<h3 id="spn-login-with-pfx-certificate"><a class="header" href="#spn-login-with-pfx-certificate">Spn login with pfx certificate</a></h3>
<pre><code class="language-yaml">kind: Config
preferences: {}
users:
  - name: demouser
    user:
      exec:
        apiVersion: client.authentication.k8s.io/v1beta1
        args:
          - get-token
          - --environment
          - AzurePublicCloud
          - --server-id
          - &lt;AAD server app ID&gt;
          - --client-id
          - &lt;AAD client app ID&gt;
          - --client-certificate
          - &lt;client_certificate_path&gt;
          - --tenant-id
          - &lt;AAD tenant ID&gt;
          - --login
          - spn
        command: kubelogin
        env: null
</code></pre>
<h3 id="managed-service-identity"><a class="header" href="#managed-service-identity">Managed Service Identity</a></h3>
<pre><code class="language-yaml">kind: Config
preferences: {}
users:
  - name: user-name
    user:
      exec:
        apiVersion: client.authentication.k8s.io/v1beta1
        command: kubelogin
        args:
          - get-token
          - --server-id
          - &lt;AAD server app ID&gt;
          - --login
          - msi
</code></pre>
<h3 id="managed-service-identity-with-specific-client-id"><a class="header" href="#managed-service-identity-with-specific-client-id">Managed Service Identity with specific client ID</a></h3>
<pre><code class="language-yaml">kind: Config
preferences: {}
users:
  - name: user-name
    user:
      exec:
        apiVersion: client.authentication.k8s.io/v1beta1
        command: kubelogin
        args:
          - get-token
          - --server-id
          - &lt;AAD server app ID&gt;
          - --client-id
          - &lt;MSI app ID&gt;
          - --login
          - msi
</code></pre>
<h3 id="azure-cli-token-login"><a class="header" href="#azure-cli-token-login">Azure CLI token login</a></h3>
<pre><code class="language-yaml">kind: Config
preferences: {}
users:
  - name: demouser
    user:
      exec:
        apiVersion: client.authentication.k8s.io/v1beta1
        args:
          - get-token
          - --server-id
          - &lt;AAD server app ID&gt;
          - --login
          - azurecli
        command: kubelogin
        env: null
</code></pre>
<h3 id="workload-identity"><a class="header" href="#workload-identity">Workload Identity</a></h3>
<pre><code class="language-yaml">kind: Config
preferences: {}
users:
  - name: demouser
    user:
      exec:
        apiVersion: client.authentication.k8s.io/v1beta1
        args:
          - get-token
          - --server-id
          - &lt;AAD server app ID&gt;
          - --login
          - workloadidentity
        command: kubelogin
        env: null
</code></pre>
<h2 id="setup-for-kubernetes-oidc-provider-using-azure-ad"><a class="header" href="#setup-for-kubernetes-oidc-provider-using-azure-ad">Setup for Kubernetes OIDC Provider using Azure AD</a></h2>
<p>Kubelogin can be used to authenticate to general kubernetes clusters using AAD as an OIDC provider. </p>
<ol>
<li>Create an AAD Enterprise Application and the corresponding App Registration. Check the <code>Allow public client flows</code> checkbox. Configure groups to be included in the response. Take a note of the directory (tenant) ID as <code>$AAD_TENANT_ID</code> and the application (client) ID as <code>$AAD_CLIENT_ID</code></li>
<li>Configure the API server with the following flags:</li>
</ol>
<ul>
<li>Issuer URL: <code>--oidc-issuer-url=https://sts.windows.net/$AAD_TENANT_ID/</code></li>
<li>Client ID: <code>--oidc-client-id=$AAD_CLIENT_ID</code></li>
<li>Username claim: <code>--oidc-username-claim=upn</code></li>
</ul>
<p>See the <a href="https://kubernetes.io/docs/reference/access-authn-authz/authentication/#configuring-the-api-server">kubernetes docs for optional flags</a>. For EKS clusters <a href="https://docs.amazonaws.cn/en_us/eks/latest/userguide/authenticate-oidc-identity-provider.html">configure this on the Management Console</a> or via <a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/eks_identity_provider_config">terraform</a>.</p>
<ol start="3">
<li>Configure kubelogin to use the application from the first step:</li>
</ol>
<pre><code>kubectl config set-credentials &quot;azure-user&quot; \
  --exec-api-version=client.authentication.k8s.io/v1beta1 \
  --exec-command=kubelogin \
  --exec-arg=get-token \
  --exec-arg=--environment \
  --exec-arg=AzurePublicCloud \
  --exec-arg=--server-id \
  --exec-arg=$AAD_CLIENT_ID \
  --exec-arg=--client-id \
  --exec-arg=$AAD_CLIENT_ID \
  --exec-arg=--tenant-id \
  --exec-arg=$AAD_TENANT_ID
</code></pre>
<ol start="4">
<li>Use this credential to connect to the cluster:</li>
</ol>
<pre><code>kubectl config set-context &quot;$CLUSTER_NAME&quot; --cluster=&quot;$CLUSTER_NAME&quot; --user=azure-user
kubectl config use-context &quot;$CLUSTER_NAME&quot;
</code></pre>
<h3 id="known-limitation"><a class="header" href="#known-limitation">Known limitation</a></h3>
<ul>
<li><a href="https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-fed-group-claims">Maximum 200 groups will be included in the OIDC JWT</a>. For more than 200 groups, consider using <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/howto-add-app-roles-in-azure-ad-apps">Application Roles</a></li>
<li>Groups created in AAD can only be included by their ObjectID and not name, as <a href="https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-fed-group-claims#group-claims-for-applications-migrating-from-ad-fs-and-other-identity-providers"><code>sAMAccountName</code> is only available for groups synchronized from Active Directory</a></li>
</ul>
<h2 id="contributing"><a class="header" href="#contributing">Contributing</a></h2>
<p>This project welcomes contributions and suggestions. Most contributions require you to agree to a
Contributor License Agreement (CLA) declaring that you have the right to, and actually do, grant us
the rights to use your contribution. For details, visit <a href="https://cla.opensource.microsoft.com">https://cla.opensource.microsoft.com</a>.</p>
<p>When you submit a pull request, a CLA bot will automatically determine whether you need to provide
a CLA and decorate the PR appropriately (e.g., status check, comment). Simply follow the instructions
provided by the bot. You will only need to do this once across all repos using our CLA.</p>
<p>This project has adopted the <a href="https://opensource.microsoft.com/codeofconduct/">Microsoft Open Source Code of Conduct</a>.
For more information see the <a href="https://opensource.microsoft.com/codeofconduct/faq/">Code of Conduct FAQ</a> or
contact <a href="mailto:opencode@microsoft.com">opencode@microsoft.com</a> with any additional questions or comments.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->

                            <a rel="next" href="development.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

                    <a rel="next" href="development.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
